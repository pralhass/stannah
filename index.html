<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Selecionar ponto focal</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 40px;
    }

    input, select, button {
      padding: 10px;
      font-size: 16px;
      margin: 10px;
      width: 300px;
    }

    input.error, select.error {
      border: 2px solid red;
    }

    .char-count {
      font-size: 12px;
      color: #666;
      margin-top: -8px;
      margin-bottom: 10px;
    }

    .char-count.exceeded {
      color: red;
      font-weight: bold;
    }

    img {
      margin-top: 20px;
      max-width: 80%;
      border: 1px solid #ccc;
    }

    #previewTemplate {
      margin-top: 20px;
      max-width: 400px;
      display: none;
    }

    #submitButton {
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    #submitButton:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h2>Preenche os dados e clica no ponto focal da imagem</h2>

  <select id="template">
    <option value="">Seleciona um template</option>
    <option value="StannahGuidelines">Stannah Guidelines</option>
    <option value="NewLookV2">New Look V2</option>
    <option value="NewLookV3">New Look V3</option>
    <option value="NewLookV4">New Look V4</option>
  </select>
  <br />
  <img id="previewTemplate" alt="Pré-visualização do template" />
  <br />

  <input type="text" id="title" placeholder="Título (máx. 40 carateres)" maxlength="40" />
  <div id="titleCount" class="char-count">0/40</div>

  <input type="text" id="subtitle" placeholder="Subtítulo (máx. 90 carateres)" maxlength="90" />
  <div id="subtitleCount" class="char-count">0/90</div>

  <input type="text" id="cta" placeholder="Call to Action (máx. 25 carateres)" maxlength="25" />
  <div id="ctaCount" class="char-count">0/25</div>

  <input type="text" id="imageUrlInput" placeholder="URL da Imagem" />
  <br />

  <button onclick="loadImage()">Carregar imagem</button>
  <br />
  <img id="image" style="display:none;" />
  <br />
  <button id="submitButton">Enviar</button>

  <script>
    const img = document.getElementById("image");
    const imageUrlInput = document.getElementById("imageUrlInput");
    const templateSelect = document.getElementById("template");
    const previewImg = document.getElementById("previewTemplate");

    const charLimits = {
      title: 40,
      subtitle: 90,
      cta: 25
    };

    const fields = {
      title: document.getElementById("title"),
      subtitle: document.getElementById("subtitle"),
      cta: document.getElementById("cta")
    };

    const counters = {
      title: document.getElementById("titleCount"),
      subtitle: document.getElementById("subtitleCount"),
      cta: document.getElementById("ctaCount")
    };

    let focusX = null;
    let focusY = null;

    function updateCharCount(fieldName) {
      const field = fields[fieldName];
      const count = field.value.length;
      const max = charLimits[fieldName];
      const counter = counters[fieldName];

      counter.textContent = `${count}/${max}`;
      const exceeded = count > max;
      field.classList.toggle("error", exceeded);
      counter.classList.toggle("exceeded", exceeded);
    }

    Object.keys(fields).forEach(name => {
      fields[name].addEventListener("input", () => updateCharCount(name));
    });

    function convertGoogleDriveUrl(url) {
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)\//);
      if (match && match[1]) {
        const id = match[1];
        return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
      }
      return url;
    }

    const templatePreviewsRaw = {
      "StannahGuidelines": "https://drive.google.com/file/d/1G9oWyGbD2c9oUwmGmI-SUYYTm2RuIldW/view?usp=sharing",
      "NewLookV2": "https://drive.google.com/file/d/1jR5Upc8gsuzTV2ykx9qDYNAaXjksVhOo/view?usp=drive_link",
      "NewLookV3": "https://drive.google.com/file/d/1lzNWQFXRwnv0n5GrCfLl284TTLyyF5jM/view?usp=drive_link",
      "NewLookV4": "https://drive.google.com/file/d/1M6N8GLorcmVOmonXc0sq6nGpiAxMnvHi/view?usp=drive_link"
    };

    templateSelect.addEventListener("change", function () {
      const selected = templateSelect.value;
      if (templatePreviewsRaw[selected]) {
        const converted = convertGoogleDriveUrl(templatePreviewsRaw[selected]);
        previewImg.src = converted;
        previewImg.style.display = "block";
      } else {
        previewImg.style.display = "none";
      }
    });

    function loadImage() {
      const rawUrl = imageUrlInput.value.trim();
      const url = convertGoogleDriveUrl(rawUrl);
      img.src = url;
      img.style.display = "block";
    }

    img.addEventListener("click", function (e) {
      const rect = img.getBoundingClientRect();
      focusX = Math.round(((e.clientX - rect.left) / img.width) * 100);
      focusY = Math.round(((e.clientY - rect.top) / img.height) * 100);
      alert(`Ponto focal selecionado:\nX: ${focusX}%\nY: ${focusY}%`);
    });

    document.getElementById("submitButton").addEventListener("click", function () {
      let missingFields = [];

      Object.entries(fields).forEach(([key, field]) => {
        const max = charLimits[key];
        const isEmpty = !field.value.trim();
        const isTooLong = field.value.length > max;
        const invalid = isEmpty || isTooLong;

        field.classList.toggle("error", invalid);

        if (invalid) {
          const labelMap = {
            title: "Título",
            subtitle: "Subtítulo",
            cta: "Call to Action"
          };
          missingFields.push(labelMap[key]);
        }
      });

      const imageUrl = imageUrlInput.value.trim();
      const template = templateSelect.value;

      if (!imageUrl) {
        imageUrlInput.classList.add("error");
        missingFields.push("URL da Imagem");
      }

      if (!template) {
        templateSelect.classList.add("error");
        missingFields.push("Template");
      }

      if (focusX === null || focusY === null) {
        missingFields.push("Selecionar ponto focal na imagem");
      }

      if (missingFields.length > 0) {
        alert(`Por favor corrige os seguintes campos:\n- ${missingFields.join("\n- ")}`);
        return;
      }

      const data = {
        title: fields.title.value.trim(),
        subtitle: fields.subtitle.value.trim(),
        cta: fields.cta.value.trim(),
        image_url: imageUrl,
        template: template,
        focus_x: focusX,
        focus_y: focusY
      };

      fetch("https://hook.eu2.make.com/ud2ltvos440cz2b6kw82dykit54gxurv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      alert(`Dados enviados com sucesso!\nX: ${focusX}%\nY: ${focusY}%`);
    });
  </script>
</body>
</html>
